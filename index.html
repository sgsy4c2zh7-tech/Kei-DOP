<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>GNSS DOP Heatmap – CelesTrak + satellite.js</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #f5f5f5;
    }
    h1, h2, h3 {
      margin: 0;
      letter-spacing: 0.03em;
    }
    h1 { font-size: 18px; }
    h2 { font-size: 15px; }
    h3 { font-size: 13px; }

    .page {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .toolbar {
      padding: 8px 12px;
      background: rgba(5, 8, 22, 0.96);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: grid;
      grid-template-columns: 2.7fr 2.7fr 2fr 2fr;
      grid-gap: 10px;
      align-items: center;
      z-index: 1000;
    }

    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      align-items: center;
    }

    .toolbar label {
      font-size: 11px;
      opacity: 0.85;
      white-space: nowrap;
    }

    .toolbar input[type="number"],
    .toolbar select {
      font-size: 11px;
      padding: 2px 4px;
      background: #0b1020;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: #f5f5f5;
    }

    .toolbar input[type="color"] {
      width: 24px;
      height: 18px;
      padding: 0;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
    }

    .toolbar input[type="range"] {
      width: 120px;
    }

    .toolbar button {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    .toolbar button:hover {
      opacity: 0.9;
    }

    .map-container {
      position: relative;
      flex: 1;
      min-height: 0;
    }

    #map {
      position: absolute;
      inset: 0;
      z-index: 200;
    }

    /* Leaflet canvas上にかぶせるヒートマップ用レイヤ（Rect） */
    .leaflet-overlay-pane svg .dop-cell {
      stroke-width: 0;
    }

    .status-bar {
      position: absolute;
      left: 10px;
      bottom: 8px;
      z-index: 900;
      padding: 6px 10px;
      background: rgba(5, 8, 22, 0.85);
      border-radius: 999px;
      font-size: 11px;
      display: flex;
      gap: 10px;
      align-items: center;
      border: 1px solid rgba(255,255,255,0.12);
    }

    .status-bar span.label {
      opacity: 0.75;
    }

    .status-bar span.value {
      font-variant-numeric: tabular-nums;
    }

    #statusText {
      position: absolute;
      right: 10px;
      bottom: 8px;
      z-index: 900;
      padding: 6px 10px;
      background: rgba(127, 29, 29, 0.9);
      color: #fecaca;
      font-size: 11px;
      border-radius: 8px;
      max-width: 360px;
      display: none;
    }

    .colorbar-preview {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
      margin-top: 2px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .checkbox-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 11px;
    }
    .checkbox-row label span {
      margin-left: 2px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="toolbar">
      <!-- GNSS & DOP -->
      <div class="toolbar-group">
        <div class="checkbox-row">
          <label><input type="checkbox" class="sys-check" value="gps" checked><span>GPS</span></label>
          <label><input type="checkbox" class="sys-check" value="galileo" checked><span>Galileo</span></label>
          <label><input type="checkbox" class="sys-check" value="glonass" checked><span>GLONASS</span></label>
          <label><input type="checkbox" class="sys-check" value="beidou" checked><span>BeiDou</span></label>
          <label><input type="checkbox" class="sys-check" value="qzss" checked><span>QZSS</span></label>
        </div>
        <label>
          DOP:
          <select id="dopType">
            <option value="GDOP">GDOP</option>
            <option value="PDOP">PDOP</option>
            <option value="HDOP">HDOP</option>
            <option value="VDOP">VDOP</option>
          </select>
        </label>
        <label>
          仰角マスク(°):
          <input id="elevMask" type="number" value="15" min="0" max="45" step="1" />
        </label>
        <label>
          基準高度(km):
          <input id="obsHeightKm" type="number" value="0" step="0.1" />
        </label>
      </div>

      <!-- 時間オフセット & フォーカス -->
      <div class="toolbar-group">
        <label>
          時間オフセット(h, -120〜+120):
          <input id="timeOffsetHours" type="range" min="-120" max="120" step="1" value="0" />
        </label>
        <span id="timeOffsetLabel" style="font-size:11px;min-width:72px;">Δt = 0 h</span>
        <span id="utcTimeLabel" style="font-size:11px;white-space:nowrap;">UTC: -</span>
        <button id="resetTime">Δt=0</button>
        <label>
          フォーカス:
          <select id="focusRegion">
            <option value="world">World</option>
            <option value="japan">Japan</option>
            <option value="us">USA</option>
            <option value="europe">Europe</option>
            <option value="australia">Australia</option>
            <option value="southamerica">South America</option>
            <option value="africa">Africa</option>
          </select>
        </label>
      </div>

      <!-- カラーバー & 透明度 -->
      <div class="toolbar-group">
        <label>
          DOP min:
          <input id="dopMin" type="number" value="0.5" step="0.1" />
        </label>
        <label>
          DOP max:
          <input id="dopMax" type="number" value="10" step="0.5" />
        </label>
        <label>
          色(低):
          <input id="colorLow" type="color" value="#22c55e" />
        </label>
        <label>
          色(中):
          <input id="colorMid" type="color" value="#eab308" />
        </label>
        <label>
          色(高):
          <input id="colorHigh" type="color" value="#ef4444" />
        </label>
        <div class="colorbar-preview" id="colorbarPreview"></div>
      </div>

      <!-- 透明度 & 実行 -->
      <div class="toolbar-group">
        <label>
          ヒートマップ透明度:
          <input id="alphaSlider" type="range" min="0.1" max="1" step="0.05" value="0.7" />
        </label>
        <span id="alphaLabel" style="font-size:11px;">α = 0.70</span>
        <button id="reloadTle">TLE更新</button>
        <button id="recalcBtn">再計算</button>
      </div>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <div class="status-bar">
        <span class="label">エポック:</span>
        <span class="value" id="epochLabel">読み込み中...</span>
        <span class="label">可視衛星数(東京):</span>
        <span class="value" id="visibleTokyoLabel">–</span>
        <span class="label">DOP(東京):</span>
        <span class="value" id="dopTokyoLabel">–</span>
      </div>
      <div id="statusText"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>

  <!-- satellite.js (SGP4) -->
  <script src="https://unpkg.com/satellite.js@5.0.0/dist/satellite.min.js"></script>

  <script>
    // ====== 設定 ======
    const systemsConfig = {
      gps:     { label: "GPS",     group: "gps-ops" },
      galileo: { label: "Galileo", group: "galileo" },
      glonass: { label: "GLONASS", group: "glonass" },
      beidou:  { label: "BeiDou",  group: "beidou" },
      qzss:    { label: "QZSS",    group: "qzss" }
    };

    // グリッド解像度（°）
    const LAT_STEP = 10;
    const LON_STEP = 10;

    // ====== 状態変数 ======
    let allSatellites = []; // {name, system, satrec}
    let lastTleEpochText = "–";
    let dopLayer = null;
    let currentAlpha = 0.7;

    // タイムスライダー基準時刻（ページ読み込み時の UTC）
    const baseTime = new Date();  // ブラウザの「今」

    // ====== UI 要素 ======
    const dopTypeSel   = document.getElementById("dopType");
    const elevMaskEl   = document.getElementById("elevMask");
    const obsHeightEl  = document.getElementById("obsHeightKm");
    const timeOffsetEl = document.getElementById("timeOffsetHours");
    const timeOffsetLabel = document.getElementById("timeOffsetLabel");
    const utcTimeLabel = document.getElementById("utcTimeLabel");
    const focusRegionEl   = document.getElementById("focusRegion");
    const dopMinEl    = document.getElementById("dopMin");
    const dopMaxEl    = document.getElementById("dopMax");
    const colorLowEl  = document.getElementById("colorLow");
    const colorMidEl  = document.getElementById("colorMid");
    const colorHighEl = document.getElementById("colorHigh");
    const colorbarPreview = document.getElementById("colorbarPreview");
    const alphaSlider = document.getElementById("alphaSlider");
    const alphaLabel  = document.getElementById("alphaLabel");
    const reloadTleBtn= document.getElementById("reloadTle");
    const recalcBtn   = document.getElementById("recalcBtn");
    const epochLabel  = document.getElementById("epochLabel");
    const visibleTokyoLabel = document.getElementById("visibleTokyoLabel");
    const dopTokyoLabel     = document.getElementById("dopTokyoLabel");
    const statusText  = document.getElementById("statusText");
    const sysChecks   = document.querySelectorAll(".sys-check");

    // ====== Leaflet map 初期化 ======
    const map = L.map("map", {
      worldCopyJump: true,
      center: [35, 140], // 日本付近
      zoom: 3
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 8,
      minZoom: 2,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // DOP 表示用レイヤ
    dopLayer = L.layerGroup().addTo(map);

    // ====== ヘルパー: メッセージ ======
    function setStatus(msg, isError = false) {
      if (!msg) {
        statusText.style.display = "none";
        statusText.textContent = "";
        return;
      }
      statusText.style.display = "block";
      statusText.textContent = msg;
      statusText.style.background = isError ? "rgba(127,29,29,0.9)" : "rgba(15,23,42,0.9)";
      statusText.style.color = isError ? "#fecaca" : "#e5e7eb";
    }

    // ====== ヘルパー: カラー関連 ======
    function hexToRgb(hex) {
      const m = hex.replace("#", "");
      const bigint = parseInt(m, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return { r, g, b };
    }

    function interpColor(c1, c2, t) {
      return {
        r: Math.round(c1.r + (c2.r - c1.r) * t),
        g: Math.round(c1.g + (c2.g - c1.g) * t),
        b: Math.round(c1.b + (c2.b - c1.b) * t)
      };
    }

    function colorForDop(value, minV, maxV, lowHex, midHex, highHex) {
      if (value == null || isNaN(value)) return "rgba(0,0,0,0)";
      if (value <= minV) value = minV;
      if (value >= maxV) value = maxV;
      const t = (valu
